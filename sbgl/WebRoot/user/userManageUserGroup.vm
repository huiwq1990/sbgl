<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>北京电影学院摄影系 - 用户管理</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="">
<meta name="author" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="${cssDomain}/bootstrap.css" rel="stylesheet" type="text/css" />
<link href="${cssDomain}/global.css" rel="stylesheet" type="text/css" />

<!--[if lt IE 10]>
  <script src="../js/jquery.placeholder.js"></script>
  <script>
  $('input, textarea').placeholder();
  </script>
<![endif]-->
<!--[if lt IE 9]>
  <script src="../js/html5shiv.js"></script>
  <script src="../js/respond.min.js"></script>
<![endif]-->
<!--[if IE 7]>
<link rel="stylesheet" href="css/font-awesome-ie7.min.css">
<![endif]-->
</head>

<body id="admin">
<header id="header-wrap"><!--header-wrap-->
  <div id="global-header">
    <div id="logo"><a class="brand" href="#"><img src="${imageDomain}/logo.png" alt="北京电影学院摄影系"></a></div>
    <div id="hdc-wrap">
      <div class="search-wrap">
        <form class="form-search">
          <div class="ipt-wrap form-group"><input type="text" class="form-control"></div>
          <button type="submit" class="btn btn-primary"><i class="icon-search"></i></button>
        </form>
      </div>
    </div>
    <ul class="account-wrap nav nav-pills pull-right">
      <li class="notice dropdown">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#"><i class="icon-bell icon-large"></i><span class="n-num label label-important">3</span></a>
        <ul class="dropdown-menu">
          <li><a href="#">消息1</a></li>
          <li><a href="#">消息2</a></li>
        </ul>
      </li>     
      <li class="social dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span class="username">陈诚</span><img src="${imageDomain}/photo.jpg" width="48" height="48" class="img-circle"> <b class="caret"></b></a>
        <div class="dropdown-menu">
          <div class="media">
            <a class="pull-left" href="#">
              <img src="${imageDomain}/photo.jpg" width="96" height="96" class="img-rounded">
            </a>
            <div class="media-body">
              <div class="media-heading"><h5><a href="#">陈诚</a></h5></div>
              <div class="info">2012级研究生 - 影像视觉效果研究方向</div>
              <div class="setting"><a href="#">账户设置</a></div>
              <button class="btn btn-primary" type="button">查看个人主页</button>
            </div>
          </div>
        </div>      
      </li>
    </ul>
  </div>
  
  <div class="nav-wrap clearfix">
    <div class="site-nav">
      <div class="dropdown">
        <a class="pos dropdown-toggle" data-hover="dropdown" href="#"><i class="icon-home"></i> 管理中心 <i class="icon-chevron-right"></i></a>
        <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
          <li><a href="http://google.com"><i class="icon-home"></i> 首页</a></li>
          <li class="divider"></li>
          <li><a href="#anotherAction">个人主页</a></li>
          <li><a href="#">人脉</a></li>
          <li class="divider"></li>
          <li><a href="#">Separated link</a></li>
        </ul>
      </div>
    </div>
    <div class="sub-nav">
      <ul class="nav nav-tabs nav-tabs-google">
        <li><a href="#">首页</a></li>
        <li><a href="#">设置</a></li>
        <li class="active"><a href="#">用户</a></li>
        <li><a href="#">设备</a></li>
        <li><a href="#">内容</a></li>
      </ul>
    </div>
  </div>

</header><!--/#header-wrap-->
<section id="main-wrap" class="clearfix"><!--main-wrap-->

      <!--admin-wrap start-->
      <div id="admin-wrap">
        <div id="admin-content" class="clearfix">    
            <!--control-bar start-->
            <div class="control-bar clearfix">
              <div class="title pull-left">用户组管理</div>
              <div class="tips">在此页面下添加新的用户组或者管理现有用户组。</div>
              <div class="operate-item pull-left">
                <a href="#add-equip-category" class="btn btn-primary" action-type="clearInput" data-toggle="modal" role="button">添加用户组</a>
                <a href="#" class="btn btn-white s-h" action-type="delUserGroup"><i class="icon-trash"></i> 删除</a>
              </div>
            </div><!--control-bar end-->
            <div class="panel panel-default">
            
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th class="chk-column"><input class="chk" id="chk-all" type="checkbox" rel="tooltip" data-original-title="全选"></th>
                    <th class="name">名称</th>
                    <th class="f-category">组分类</th>
                  </tr>
                </thead>
                <tbody>
				  #foreach($group in $allGroupList)
				    #if($group.type != 0)
					  <tr>
                        <td><input class="chk" type="checkbox" name="chk-list" value="$!group.id"></td>
                        <td>$!group.name<a class="btn btn-white btn-mini" action-type="beforeModify" data-id="$!group.id" data-name="$!group.name" data-type="$!group.type" data-toggle="modal" href="#modify-equip-category" role="button">修改</a></td>
						#if($!group.type == 2)
						<td>学生</td>
						#elseif($!group.type == 6)
						<td>教师</td>
						#elseif($!group.type == -1)
						<td>其他</td>
						#end
                  	 </tr>
				    #end
                  #end
                </tbody>
              </table>
              
            </div>
          </div>

      </div>
      <!--admin-wrap end-->
      <!--sidebar start-->
      <div id="lside">
        <!-- <form class="form-group">
          <input type="text" class="form-control" placeholder="搜索设备">
          <i class="icon-search"></i>
        </form>  -->      
        <div class="list-group">
          <a href="${webbaseurl}/userManageUser.do" class="list-group-item">用户管理</a>
          <a href="${webbaseurl}/userManageUserAdd.do" class="list-group-item">添加用户</a>
          <a href="${webbaseurl}/userManageUserGroup.do" class="list-group-item active">用户组</a>
          <a href="${webbaseurl}/userManageClass.do" class="list-group-item">班级管理</a>
          <!-- <a href="用户管理-发送通知.html" class="list-group-item">发送通知</a> -->
          <a href="${webbaseurl}/userManageAdmin.do" class="list-group-item">管理员管理</a>
          <a href="${webbaseurl}/userManageAdminAdd.do" class="list-group-item">添加管理员</a>
          <a href="${webbaseurl}/userManageAdminGroup.do" class="list-group-item">管理组</a>
          <!-- <a href="用户管理-用户认证.html" class="list-group-item">用户认证</a> -->
        </div>

      </div>
      <!--sidebar end-->

</section>

<!-- Modal -->
<div id="add-equip-category" class="modal hide fade" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none; ">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="icon-remove"></i></button>
    <h3 id="myModalLabel">添加用户组</h3>
  </div>
  <div class="modal-body">
    <p>添加组信息。</p>
    <form class="form-horizontal" role="form">
      <div class="form-group">
        <label for="inputCategoryName" class="col-xs-3 control-label">组名称</label>
        <div class="col-xs-7">
          <input type="text" class="form-control" id="inputGroupName" placeholder="用户组名称">
        </div>
      </div>
      <div class="form-group">
        <label for="inputFaCategoryId" class="col-xs-3 control-label">类别</label>
        <div class="col-xs-7">
          <select class="select2 select-white form-control" id="inputTypeId">
		    <option value="2">学生</option>
            <option value="6">教师</option>
            <option value="-1">其他</option>
          </select>
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button class="btn btn-white" data-dismiss="modal" aria-hidden="true">取 消</button>
    <button class="btn btn-primary" action-type="addGroup">确 定</button>
  </div>
</div>       
<div id="modify-equip-category" class="modal hide fade" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none; ">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="icon-remove"></i></button>
    <h3 id="myModalLabel">修改</h3>
  </div>
  <div class="modal-body">
    <p>修改当前选定的组信息。</p>
    <form class="form-horizontal" role="form">
      <div class="form-group">
        <label for="modifyCategoryName" class="col-xs-3 control-label">组名称</label>
        <div class="col-xs-7">
          <input type="text" class="form-control" id="modifyGroupName" placeholder="用户组名称">
        </div>
      </div>
      <div class="form-group">
        <label for="modifyFaCategoryId" class="col-xs-3 control-label">类别</label>
        <div class="col-xs-7">
          <select class="select2 select-white form-control" id="modifyTypeId">
		    <option value="2">学生</option>
            <option value="6">教师</option>
            <option value="-1">其他</option>
          </select>
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button class="btn btn-white" data-dismiss="modal" aria-hidden="true">取 消</button>
    <button class="btn btn-primary" action-type="modifyGroup">确 定</button>
  </div>
</div>


    <!-- javascript
    ================================================== -->
<script src="${jsDomain}/jquery.js"></script>
<script src="${jsDomain}/loader.min.js"></script>
<script src="${jsDomain}/select2.js"></script>
<script src="${jsDomain}/bootstrap-hover-dropdown.min.js"></script>
<script src="${jsDomain}/bfa.js"></script>
<script src="${jsDomain}/jquery.noty.js"></script>

<script>
	var alterGroupName;		//修改组的原名称
	var alterGroupId;		//修改组的id
	var alterGroupId;		//修改组的类别
	var idsForDel = "";  	//用于删除的id串
	
	var cookie = { 
		//读取COOKIES,n为COOKIE名 
		Get:function(n){ 
    		var re=new RegExp(n+'=([^;]*);?','gi');
    	    var r=re.exec(document.cookie)||[];
    	    return (r.length>1?r[1]:null)
		}
	};
	
	$("body").on("click", "a[action-type|=clearInput]", function() {
		$("#inputGroupName").val("");
	});
	
	$("body").on("click", "input[type='checkbox']", function() {
		var num = 0;
		if($(this).attr("id") === "chk-all") {
			$("input[name='chk-list']").prop("checked",$(this).prop("checked"));
		}
		$("input[name='chk-list']").each(function() {
			if($(this).prop("checked") === true){
				num++;  
			}
		});
		if(num > 0){
			$(".s-h").css({
				"visibility": "visible",
				"opacity": "1",
				"filter": "alpha(opacity=100)"
			});
		} else {
			$(".s-h").css({
				"visibility": "hidden",
				"opacity": "0",
				"filter": "alpha(opacity=0)"
			});
		}
		
		idsForDel = "";
		
		$("input[name='chk-list']").each(function() {
			if($(this).prop("checked") === true) {
				//num++;
				idsForDel += $(this).prop("value") + "_";
			}
		});
	});
	
	$("body").on("click", "a[action-type|=beforeModify]", function() {
		var myData = $(this).data();
		
		alterGroupId = myData.id;
		alterGroupName = myData.name;
		alterGroupType = myData.type;
		
		$("#modifyGroupName").val(alterGroupName);
		$("#modifyTypeId").select2("val", alterGroupType);
		
		console.log(alterGroupId);
		console.log(alterGroupName);
		console.log(alterGroupType);
		
	});
	
	$('.modal').on('click', ('button.btn-primary'), function () {
		var _this = $(this);
		var postData = {};
		var actionUrl = "";
		var tip = "";
	    
	    if(_this.attr('action-type') == 'addGroup') {
	        var groupName = $("#inputGroupName").val();
	        var groupType = $("#inputTypeId").val();
    		
    		if(groupName != "") {
    			postData = {
    				"group.name": groupName,
    				"group.type": groupType,
    				"group.ownerId": cookie.Get("id")
    			}
    			actionUrl = "${webbaseurl}/addUserGroup.do";
    			tip = "添加用户组成功！";
    		} else {
    			alert("组名称不能为空！");
				return;
    		}
	    }
		
		if(_this.attr('action-type') == 'modifyClazz') {
	        var newGroupName = $("#modifyGroupName").val() == "" ? alterGroupName : $("#modifyClazzName").val();
	        var newGroupType = $("#modifyTypeId").val();
    		
    		if(alterClazzName == newClazzName && newGroupType == alterGroupType) {
    			alert("并未做修改！");
				return;
    		} else {
    			postData = {
					"group.id": alterGroupId,
					"group.name": newGroupName,
    				"group.type": newGroupType
        		};
				actionUrl = "${webbaseurl}/alterUserGroup.do";
				tip = "修改用户组成功！";
    		}
	    }
		
		jQuery.ajax({  
		    url: actionUrl,  
		    type: "post",
		    data: postData,
		    success:function(data,textStatus,jq) {  
			    var n = noty({text: tip, timeout: 2500, type: 'success'});
			    _this.parents('.modal').modal('toggle');
				$("#admin-wrap").html(data);
	        },  
		    error:function(data,textStatus,jq){
		        var n = noty({text: "系统错误，操作失败，请联系管理员！", timeout: 2500, type: 'error'});
		    }  
		});
	});
	
	$("body").on("click", "a[action-type|=delClazz]", function() {
		//alert(idsForDel);
		var postData = {
			groupIds: idsForDel,
		}
			
		jQuery.ajax({  
		    url: "${webbaseurl}/delUserGroup.do",  
		    type: "post",
		    data: postData,
		    success:function(data,textStatus,jq){ 
				var n = noty({text: "删除用户组成功！", timeout: 2500, type: 'success'});
				//$(this).parents('.modal').modal('toggle');
				$("#admin-wrap").html(data);
				
	        },  
		    error:function(data,textStatus,jq){
    			var n = noty({text: "系统异常，请联系系统管理员！", timeout: 2500, type: 'error'});
			}  
		});
	});
</script>

</script>
</body>
</html>